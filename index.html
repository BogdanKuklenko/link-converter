<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конвертер ссылок Яндекс.Музыки</title>
    <!-- Подключение Tailwind CSS для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение шрифта Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Стили для плавных переходов */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        /* Анимация "тряски" для неверного кода */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake-error {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-lg transform transition-all hover:scale-105">
        
        <!-- Заголовок -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Конвертер ссылок Яндекс.Музыки</h1>
            <p class="text-gray-500 mt-2">Для редактора QuestBook</p>
        </div>

        <!-- Пояснение -->
        <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-r-lg mb-6">
            <p class="text-sm text-indigo-800">
                <strong>Как получить код:</strong> В плейлисте на Яндекс.Музыке нажмите <strong>Поделиться → HTML-код</strong>. Скопируйте его и вставьте в поле ниже.
            </p>
        </div>

        <!-- Поле для ввода кода -->
        <div class="mb-4">
            <label for="userInput" class="block text-sm font-medium text-gray-700 mb-2">1. Вставьте HTML-код плейлиста:</label>
            <textarea 
                id="userInput" 
                rows="6"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" 
                placeholder='<iframe ...></iframe>'
            ></textarea>
        </div>

        <!-- Кнопка конвертации -->
        <div class="text-center mb-4">
            <button 
                id="convertBtn"
                class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transform hover:scale-105 transition-all"
            >
                Преобразовать
            </button>
        </div>
        
        <!-- Поле для вывода результата -->
        <div class="mb-4">
            <label for="outputUrl" class="block text-sm font-medium text-gray-700 mb-2">2. Готовая ссылка:</label>
            <div class="relative flex items-center">
                <input 
                    type="text" 
                    id="outputUrl" 
                    readonly 
                    class="w-full p-3 pr-12 bg-gray-50 border border-gray-300 rounded-lg text-gray-600"
                >
                <button id="copyBtn" title="Скопировать" class="absolute right-2 p-2 text-gray-400 hover:text-indigo-600 transition-all rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Сообщения о статусе -->
        <div id="statusMessage" class="text-center text-sm text-green-600 h-5 transition-all"></div>

    </div>

    <script>
        const userInput = document.getElementById('userInput');
        const convertBtn = document.getElementById('convertBtn');
        const outputUrl = document.getElementById('outputUrl');
        const copyBtn = document.getElementById('copyBtn');
        const statusMessage = document.getElementById('statusMessage');

        // --- Анимация ошибки ---
        function animateError() {
            const inputRect = userInput.getBoundingClientRect();
            const clone = document.createElement('div');
            clone.textContent = userInput.value;
            const computedStyle = window.getComputedStyle(userInput);
            Object.assign(clone.style, {
                position: 'absolute', top: `${inputRect.top}px`, left: `${inputRect.left}px`,
                width: `${inputRect.width}px`, height: `${inputRect.height}px`, font: computedStyle.font,
                padding: computedStyle.padding, margin: computedStyle.margin, border: '1px solid #ef4444', // Red border
                borderRadius: computedStyle.borderRadius, backgroundColor: '#fee2e2', color: computedStyle.color,
                lineHeight: computedStyle.lineHeight, zIndex: '1000', overflow: 'hidden',
                whiteSpace: 'pre-wrap', wordBreak: 'break-all', boxSizing: 'border-box'
            });
            document.body.appendChild(clone);
            userInput.style.color = 'transparent';
            
            clone.classList.add('shake-error');

            setTimeout(() => {
                clone.style.opacity = '0';
                clone.style.transform = 'scale(0.8)';
            }, 600);
            
            setTimeout(() => {
                document.body.removeChild(clone);
                userInput.value = '';
                userInput.style.color = '';
            }, 900);
        }

        // --- Анимация успеха ---
        function animateSuccess() {
            const inputRect = userInput.getBoundingClientRect();
            const outputRect = outputUrl.getBoundingClientRect();
            const clone = document.createElement('div');
            clone.textContent = userInput.value;
            const computedStyle = window.getComputedStyle(userInput);
            Object.assign(clone.style, {
                position: 'absolute', top: `${inputRect.top}px`, left: `${inputRect.left}px`,
                width: `${inputRect.width}px`, height: `${inputRect.height}px`, font: computedStyle.font,
                padding: computedStyle.padding, margin: computedStyle.margin, border: computedStyle.border,
                borderRadius: computedStyle.borderRadius, backgroundColor: 'white', color: computedStyle.color,
                lineHeight: computedStyle.lineHeight, zIndex: '1000', overflow: 'hidden',
                whiteSpace: 'pre-wrap', wordBreak: 'break-all', boxSizing: 'border-box',
                transition: 'all 0.7s cubic-bezier(0.4, 0, 0.2, 1)'
            });
            document.body.appendChild(clone);
            userInput.style.color = 'transparent';

            requestAnimationFrame(() => {
                clone.style.top = `${outputRect.top + (outputRect.height / 2)}px`;
                clone.style.left = `${outputRect.left + (outputRect.width / 2)}px`;
                clone.style.transform = 'scale(0)';
                clone.style.opacity = '0';
            });

            setTimeout(() => {
                document.body.removeChild(clone);
                userInput.value = '';
                userInput.style.color = '';
            }, 700);
        }

        // --- Основная логика ---
        function handleConvert() {
            const inputText = userInput.value.trim();
            statusMessage.textContent = '';
            outputUrl.value = '';

            if (!inputText) {
                showError('Поле ввода пустое.');
                return;
            }

            let urlToProcess = inputText;

            // Если это iframe, извлекаем из него ссылку
            if (inputText.startsWith('<iframe')) {
                const srcMatch = inputText.match(/src="([^"]+)"/);
                if (!srcMatch || !srcMatch[1]) {
                    showError('Ошибка: Не удалось найти ссылку (атрибут src) в коде.');
                    animateError();
                    return;
                }
                urlToProcess = srcMatch[1];
            }
            
            let username, playlistId;

            // Regex для прямых ссылок: .../users/USERNAME/playlists/PLAYLIST_ID
            const directLinkRegex = /users\/([^/]+)\/playlists\/([^/?]+)/;
            let match = urlToProcess.match(directLinkRegex);

            if (match && match.length === 3) {
                username = match[1];
                playlistId = match[2];
            } else {
                // Regex для iframe-ссылок: .../iframe/playlist/USERNAME/PLAYLIST_ID
                const iframeLinkRegex = /iframe\/playlist\/([^/]+)\/([^/?]+)/;
                match = urlToProcess.match(iframeLinkRegex);
                if (match && match.length === 3) {
                    username = match[1];
                    playlistId = match[2];
                }
            }

            if (username && playlistId) {
                const newUrl = `https://music.yandex.ru/users/${username}/playlists/${playlistId}`;
                outputUrl.value = newUrl;
                showSuccess('Ссылка успешно преобразована!');
                animateSuccess();
                return;
            }

            // Если правильный формат не найден, ищем причину ошибки
            if (urlToProcess.includes('/album/')) {
                showError('Эта ссылка не подходит. Нужен HTML-код от плейлиста.');
                animateError();
                return;
            }
            
            if (/\/playlists\/[a-f0-9-]+/.test(urlToProcess)) {
                showError('Эта ссылка не подходит. Нужен HTML-код от плейлиста.');
                animateError();
                return;
            }

            // Общая ошибка, если ничего не подошло
            showError('Ошибка: Неверный формат. Убедитесь, что это HTML-код или ссылка на плейлист, созданный пользователем.');
            animateError();
        }

        // --- Вспомогательные функции ---
        function copyToClipboard() {
            if (!outputUrl.value) {
                showError('Сначала преобразуйте ссылку.');
                return;
            }
            outputUrl.select();
            document.execCommand('copy');
            showSuccess('Скопировано в буфер обмена!');
        }

        function showError(message) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('text-green-600');
            statusMessage.classList.add('text-red-600');
        }

        function showSuccess(message) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('text-red-600');
            statusMessage.classList.add('text-green-600');
        }
        
        convertBtn.addEventListener('click', handleConvert);
        copyBtn.addEventListener('click', copyToClipboard);

    </script>

</body>
</html>
